pipeline {
  agent {
        node {
            label 'team:makerspace'
        }
    }
  parameters {
        gitParameter name: 'BRANCH_TAG',
                     type: 'PT_BRANCH_TAG',
                     defaultValue: 'master'
        choice(choices: ['test', 'qa', 'prod'], description: 'Tier to deploy tiles to', name: 'TIER')
  }
  stages {
    stage('Clean Workspace') {
	    steps{
		    cleanWs()
	    }
	  }
    stage('Checkout repo and pull from S3') {
      steps {
        sh 'wget -O DOIRootCA2.cer http://sslhelp.doi.net/docs/DOIRootCA2.cer'
         checkout([$class: 'GitSCM',
                          branches: [[name: "${params.BRANCH_TAG}"]],
                          doGenerateSubmoduleConfigurations: false,
                          extensions: [],
                          gitTool: 'Default',
                          submoduleCfg: [],
                          userRemoteConfigs: [[url: 'https://github.com/wdwatkins/wbeep-processing']]
                        ])
        sh 'aws s3 sync s3://prod-owi-resources/resources/Application/wbeep/${TIER}/hru_shape . --exclude "*" --include "hrus.geojson"'
      }
    }
    stage('create tileset') {
      agent {
        docker.withRegistry('code.chs.usgs.gov:5001/wma/iidd/wbeep-data-processing', 'jenkins_ci_access_token') {
          docker.image('tippecanoe-latest')
          alwaysPull true
          reuseNode true
        } 
      }
      steps {
        sh '''
          DOCKER_WORKSPACE=${WORKSPACE}
          tippecanoe -zg --no-tiny-polygon-reduction --simplify-only-low-zooms --simplification=5 --force --output-to-directory ${WORKSPACE}/tile_dir_simple5 ${WORKSPACE}/hrus.geojson
          mkdir -p tile_dir_simple5
          '''
      }
    }
    stage('push to S3') {
      steps { 
        sh 'aws s3 sync tile_dir_simple5 s3://prod-owi-resources/resources/Application/wbeep/${TIER}/hru_shape/tile_dir_simple5'
      }
    }
    stage('build downstream job') {
      steps { 
        sh "echo ${params.BRANCH_TAG}"
        build job: 'process_model_output', 
              parameters: [string(name: 'TIER', value: String.valueOf(TIER)),
              string(name: 'BRANCH_TAG', value: "${params.BRANCH_TAG}")]
      }
    }
  }
}
